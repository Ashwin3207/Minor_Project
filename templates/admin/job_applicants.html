{% extends "base.html" %}
{% block title %}Job Applicants - {{ job.company_name }}{% endblock %}

{% block content %}

<div class="container-fluid py-4">
    <!-- Back Button and Job Header -->
    <div class="mb-4">
        <a href="{{ url_for('admin.view_jobs') }}" class="btn btn-outline-secondary mb-3">
            <i class="bi bi-arrow-left me-2"></i> Back to Jobs
        </a>
        
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h2 class="mb-2">{{ job.company_name }}</h2>
                        <p class="text-muted mb-2">
                            <strong>Job Description:</strong><br>
                            <span class="text-dark">{{ job.job_description[:200] }}{% if job.job_description|length > 200 %}...{% endif %}</span>
                        </p>
                        <div class="row g-3 mt-3">
                            <div class="col-sm-6">
                                <strong>CTC:</strong> <span class="badge bg-success">{{ job.ctc }}</span>
                            </div>
                            <div class="col-sm-6">
                                <strong>Min CGPA:</strong> <span class="badge bg-info">{{ job.min_cgpa }}</span>
                            </div>
                            <div class="col-sm-6">
                                <strong>Allowed Branches:</strong> <span class="badge bg-warning text-dark">{{ job.allowed_branches }}</span>
                            </div>
                            <div class="col-sm-6">
                                <strong>Deadline:</strong> <span class="badge bg-danger">{{ job.deadline.strftime('%d-%m-%Y %H:%M') }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light border-0">
                            <div class="card-body text-center">
                                <h5 class="card-title text-muted">Total Applicants</h5>
                                <h2 class="display-4 fw-bold text-primary">{{ applications.total }}</h2>
                                <hr>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <small class="text-muted">Applied</small>
                                        <p class="fw-bold text-info">{{ applications.items|selectattr('status', 'equalto', 'Applied')|list|length }}</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Shortlisted</small>
                                        <p class="fw-bold text-success">{{ applications.items|selectattr('status', 'equalto', 'Shortlisted')|list|length }}</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Selected</small>
                                        <p class="fw-bold text-success">{{ applications.items|selectattr('status', 'equalto', 'Selected')|list|length }}</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Rejected</small>
                                        <p class="fw-bold text-danger">{{ applications.items|selectattr('status', 'equalto', 'Rejected')|list|length }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <form method="get" action="{{ url_for('admin.job_applicants', job_id=job.id) }}" class="row g-3">
                <div class="col-md-6">
                    <label for="status" class="form-label">Filter by Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">All Statuses</option>
                        <option value="Applied" {% if status_filter == 'Applied' %}selected{% endif %}>Applied</option>
                        <option value="Shortlisted" {% if status_filter == 'Shortlisted' %}selected{% endif %}>Shortlisted</option>
                        <option value="Selected" {% if status_filter == 'Selected' %}selected{% endif %}>Selected</option>
                        <option value="Rejected" {% if status_filter == 'Rejected' %}selected{% endif %}>Rejected</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <i class="bi bi-funnel me-2"></i> Apply Filter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Applicants Table -->
    {% if applications.items %}
        <div class="card shadow-sm border-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>CGPA</th>
                            <th>Branch</th>
                            <th>Status</th>
                            <th>Applied Date</th>
                            <th>Profile</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for application in applications.items %}
                            <tr>
                                <td>
                                    <strong>{{ application.student.username }}</strong>
                                </td>
                                <td>
                                    <small>{{ application.student.email }}</small>
                                </td>
                                <td>
                                    {% if application.student.student_profile %}
                                        <span class="badge bg-primary">{{ application.student.student_profile.cgpa }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if application.student.student_profile %}
                                        <small>{{ application.student.student_profile.branch }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if application.status == 'Applied' %}
                                        <span class="badge bg-info">{{ application.status }}</span>
                                    {% elif application.status == 'Shortlisted' %}
                                        <span class="badge bg-warning text-dark">{{ application.status }}</span>
                                    {% elif application.status == 'Selected' %}
                                        <span class="badge bg-success">{{ application.status }}</span>
                                    {% elif application.status == 'Rejected' %}
                                        <span class="badge bg-danger">{{ application.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ application.applied_at.strftime('%d-%m-%Y %H:%M') }}
                                    </small>
                                </td>
                                <td>
                                    {% if application.student.student_profile %}
                                        <button class="btn btn-sm btn-info" data-bs-toggle="modal" 
                                                data-bs-target="#profileModal{{ application.id }}" 
                                                title="View Student Profile">
                                            <i class="bi bi-person-fill me-1"></i> View Profile
                                        </button>
                                    {% else %}
                                        <span class="text-muted small">No profile</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if application.status == 'Applied' %}
                                        <div class="btn-group btn-group-sm" role="group">
                                            <form method="POST" action="{{ url_for('admin.confirm_application', application_id=application.id) }}" style="display: inline;">
                                                <button type="submit" name="status" value="Shortlisted" class="btn btn-sm btn-warning" title="Shortlist Candidate">
                                                    <i class="bi bi-check-circle me-1"></i> Shortlist
                                                </button>
                                            </form>
                                            <form method="POST" action="{{ url_for('admin.confirm_application', application_id=application.id) }}" style="display: inline;">
                                                <button type="submit" name="status" value="Rejected" class="btn btn-sm btn-danger" title="Reject Candidate">
                                                    <i class="bi bi-x-circle me-1"></i> Reject
                                                </button>
                                            </form>
                                        </div>
                                    {% elif application.status == 'Shortlisted' %}
                                        <div class="btn-group btn-group-sm" role="group">
                                            <form method="POST" action="{{ url_for('admin.confirm_application', application_id=application.id) }}" style="display: inline;">
                                                <button type="submit" name="status" value="Selected" class="btn btn-sm btn-success" title="Select Candidate">
                                                    <i class="bi bi-check2-circle me-1"></i> Select
                                                </button>
                                            </form>
                                            <form method="POST" action="{{ url_for('admin.confirm_application', application_id=application.id) }}" style="display: inline;">
                                                <button type="submit" name="status" value="Rejected" class="btn btn-sm btn-danger" title="Reject Candidate">
                                                    <i class="bi bi-x-circle me-1"></i> Reject
                                                </button>
                                            </form>
                                        </div>
                                    {% else %}
                                        <span class="badge bg-secondary">No Actions</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if applications.pages > 1 %}
                <div class="card-footer bg-light">
                    <nav aria-label="Page navigation">
                        <ul class="pagination mb-0 justify-content-center">
                            {% if applications.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" 
                                       href="{{ url_for('admin.job_applicants', job_id=job.id, page=1, status=status_filter) }}">
                                        First
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" 
                                       href="{{ url_for('admin.job_applicants', job_id=job.id, page=applications.prev_num, status=status_filter) }}">
                                        Previous
                                    </a>
                                </li>
                            {% endif %}

                            {% for page_num in applications.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num == applications.page %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% else %}
                                        <li class="page-item">
                                            <a class="page-link" 
                                               href="{{ url_for('admin.job_applicants', job_id=job.id, page=page_num, status=status_filter) }}">
                                                {{ page_num }}
                                            </a>
                                        </li>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if applications.has_next %}
                                <li class="page-item">
                                    <a class="page-link" 
                                       href="{{ url_for('admin.job_applicants', job_id=job.id, page=applications.next_num, status=status_filter) }}">
                                        Next
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" 
                                       href="{{ url_for('admin.job_applicants', job_id=job.id, page=applications.pages, status=status_filter) }}">
                                        Last
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle me-2"></i>
            No applications found for this job.
        </div>
    {% endif %}

    <!-- Profile Modals (Outside Loop) -->
    {% if applications.items %}
        {% for application in applications.items %}
            {% if application.student.student_profile %}
                <!-- Profile Modal for {{ application.student.username }} -->
                <div class="modal fade" id="profileModal{{ application.id }}" 
                     tabindex="-1" aria-labelledby="profileModalLabel{{ application.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="profileModalLabel{{ application.id }}">
                                    {{ application.student.username }}'s Profile
                                </h5>
                                <button type="button" class="btn-close" 
                                        data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <strong>Username:</strong><br>
                                        {{ application.student.username }}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Email:</strong><br>
                                        {{ application.student.email }}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>CGPA:</strong><br>
                                        {{ application.student.student_profile.cgpa }}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Branch:</strong><br>
                                        {{ application.student.student_profile.branch }}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>10th Percentage:</strong><br>
                                        {{ application.student.student_profile.tenth_percentage }}%
                                    </div>
                                    <div class="col-md-6">
                                        <strong>12th Percentage:</strong><br>
                                        {{ application.student.student_profile.twelfth_percentage }}%
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Has Backlog:</strong><br>
                                        <span class="badge {% if application.student.student_profile.has_backlog %}bg-danger{% else %}bg-success{% endif %}">
                                            {% if application.student.student_profile.has_backlog %}Yes{% else %}No{% endif %}
                                        </span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Skills:</strong><br>
                                        <small>{{ application.student.student_profile.skills or 'Not specified' }}</small>
                                    </div>
                                    {% if application.student.student_profile.resume_link %}
                                        <div class="col-12">
                                            <strong>Resume:</strong><br>
                                            <a href="{{ url_for('admin.download_student_resume', student_id=application.student.id) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-download me-1"></i> Download Resume
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
</div>

<!-- Fix for aria-hidden accessibility issue with modals -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all modals
    const modals = document.querySelectorAll('.modal');
    
    modals.forEach(modal => {
        // When modal is shown, set aria-hidden to false
        modal.addEventListener('show.bs.modal', function() {
            this.setAttribute('aria-hidden', 'false');
        });
        
        // When modal is hidden, set aria-hidden to true
        modal.addEventListener('hide.bs.modal', function() {
            this.setAttribute('aria-hidden', 'true');
        });
    });
});
</script>

{% endblock %}
