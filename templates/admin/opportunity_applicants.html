{% extends "base.html" %}
{% block title %}{{ opportunity.title }} Applicants - Admin | TPC Portal{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Applicants for {{ opportunity.title }}</h1>
        <a href="{{ url_for('admin.opportunities') }}" class="btn btn-outline-secondary">
            ← Back to Opportunities
        </a>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">{{ opportunity.title }}</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Type:</strong> <span class="badge bg-info">{{ opportunity.type }}</span></p>
                    <p><strong>Organizer:</strong> {{ opportunity.organizer or opportunity.company_name or 'Admin' }}</p>
                    {% if opportunity.type in ['Job', 'Internship'] %}
                        <p><strong>CTC:</strong> {{ opportunity.ctc or '—' }}</p>
                        <p><strong>Min CGPA:</strong> {{ opportunity.min_cgpa or '—' }}</p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <p><strong>Date:</strong> {{ opportunity.date.strftime('%d %b %Y, %I:%M %p') if opportunity.date else 'TBA' }}</p>
                    {% if opportunity.type in ['Job', 'Internship'] %}
                        <p><strong>Deadline:</strong> {{ opportunity.deadline.strftime('%d %b %Y') if opportunity.deadline else 'TBA' }}</p>
                        <p><strong>Branches:</strong> {{ opportunity.allowed_branches or 'All Branches' }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <div class="btn-group" role="group">
            <a href="{{ url_for('admin.opportunity_applicants', opp_id=opportunity.id) }}" 
               class="btn btn-sm {% if not status_filter %}btn-primary{% else %}btn-outline-primary{% endif %}">
                All ({{ applications.total }})
            </a>
            <a href="{{ url_for('admin.opportunity_applicants', opp_id=opportunity.id, status='Applied') }}" 
               class="btn btn-sm {% if status_filter == 'Applied' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                Applied
            </a>
            <a href="{{ url_for('admin.opportunity_applicants', opp_id=opportunity.id, status='Shortlisted') }}" 
               class="btn btn-sm {% if status_filter == 'Shortlisted' %}btn-info{% else %}btn-outline-info{% endif %}">
                Shortlisted
            </a>
            <a href="{{ url_for('admin.opportunity_applicants', opp_id=opportunity.id, status='Selected') }}" 
               class="btn btn-sm {% if status_filter == 'Selected' %}btn-success{% else %}btn-outline-success{% endif %}">
                Selected
            </a>
            <a href="{{ url_for('admin.opportunity_applicants', opp_id=opportunity.id, status='Rejected') }}" 
               class="btn btn-sm {% if status_filter == 'Rejected' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                Rejected
            </a>
        </div>
    </div>

    {% if applications.items %}
    <div class="card shadow-sm border-0">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Applications</h5>
            <small class="text-muted">Page {{ applications.page }} of {{ applications.pages }}</small>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Student</th>
                            <th>Email</th>
                            <th>Branch</th>
                            <th>CGPA</th>
                            <th>Applied On</th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for app in applications.items %}
                        <tr>
                            <td>{{ loop.index + (applications.page - 1) * applications.per_page }}</td>
                            <td class="fw-bold">{{ app.student.username }}</td>
                            <td>{{ app.student.email }}</td>
                            <td>
                                {{ app.student.student_profile.branch if app.student.student_profile else '—' }}
                            </td>
                            <td>
                                {{ "%.2f"|format(app.student.student_profile.cgpa) if app.student.student_profile else '—' }}
                            </td>
                            <td>{{ app.applied_at.strftime('%d %b %Y, %I:%M %p') }}</td>
                            <td>
                                {% if app.status == 'Applied' %}
                                    <span class="badge bg-warning text-dark">Applied</span>
                                {% elif app.status == 'Shortlisted' %}
                                    <span class="badge bg-info">Shortlisted</span>
                                {% elif app.status == 'Selected' %}
                                    <span class="badge bg-success">Selected</span>
                                {% elif app.status == 'Rejected' %}
                                    <span class="badge bg-danger">Rejected</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ app.status }}</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                            type="button" 
                                            data-bs-toggle="dropdown" 
                                            aria-expanded="false" 
                                            data-bs-boundary="viewport">
                                        Update
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow">
                                        <li>
                                            <form method="POST" action="{{ url_for('admin.confirm_opportunity_application', application_id=app.id) }}">
                                                <input type="hidden" name="status" value="Shortlisted">
                                                <button type="submit" class="dropdown-item" onclick="return confirm('Shortlist this applicant?')">
                                                    <i class="bi bi-check2-square me-2"></i> Shortlist
                                                </button>
                                            </form>
                                        </li>
                                        <li>
                                            <form method="POST" action="{{ url_for('admin.confirm_opportunity_application', application_id=app.id) }}">
                                                <input type="hidden" name="status" value="Selected">
                                                <button type="submit" class="dropdown-item" onclick="return confirm('Select this applicant?')">
                                                    <i class="bi bi-person-check me-2"></i> Select
                                                </button>
                                            </form>
                                        </li>
                                        <li>
                                            <form method="POST" action="{{ url_for('admin.confirm_opportunity_application', application_id=app.id) }}">
                                                <input type="hidden" name="status" value="Rejected">
                                                <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Reject this applicant?')">
                                                    <i class="bi bi-x-circle me-2"></i> Reject
                                                </button>
                                            </form>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a href="{{ url_for('admin.download_student_resume', student_id=app.student.id) }}" class="dropdown-item">
                                                <i class="bi bi-file-earmark-arrow-down me-2"></i> Download Resume
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if applications.pages > 1 %}
        <div class="card-footer bg-light">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    {% if applications.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin.opportunity_applicants', opp_id=opportunity.id, page=applications.prev_num, status=status_filter) }}">
                            ← Previous
                        </a>
                    </li>
                    {% endif %}

                    {% for page_num in applications.iter_pages() %}
                        {% if page_num %}
                            <li class="page-item {{ 'active' if page_num == applications.page else '' }}">
                                <a class="page-link" href="{{ url_for('admin.opportunity_applicants', opp_id=opportunity.id, page=page_num, status=status_filter) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    {% if applications.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin.opportunity_applicants', opp_id=opportunity.id, page=applications.next_num, status=status_filter) }}">
                            Next →
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>

    {% else %}
    <div class="text-center py-5 card shadow-sm">
        <h3 class="text-muted">No applications yet</h3>
        <p class="text-muted">Applicants will appear here once they apply for this opportunity.</p>
    </div>
    {% endif %}

</div>

<style>
    /* Crucial fix for table dropdowns */
    .table-responsive {
        overflow-x: auto; /* Allows horizontal scroll on mobile */
        overflow-y: visible !important; /* Prevents vertical clipping */
    }

    /* Standardizes the dropdown appearance */
    .dropdown-menu {
        z-index: 1060; /* Higher than sticky headers */
        min-width: 180px;
    }

    .dropdown-item {
        padding: 0.6rem 1.2rem;
        display: flex;
        align-items: center;
        width: 100%;
        background: none;
        border: none;
    }

    .dropdown-item:hover {
        background-color: #f8f9fa;
    }

    /* Form within dropdown fix */
    .dropdown-menu form {
        margin: 0;
        padding: 0;
    }
</style>
{% endblock %}